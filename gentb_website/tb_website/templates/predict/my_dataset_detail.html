{% extends "base.html" %}
{% load staticfiles %}
{% load predict_extras %}

{% block title %}
My Datasets - Phthisis Ravens
{% endblock %}

{% block extra_js %}
{% endblock %}

{% block content %}

<div class="row">
    <div class="col-lg-12">
        Return to <a href="{% url 'view_my_datasets' %}">My Datasets ({{ my_dataset_count }})</a>

        <h1>Dataset: <span style="font-weight:normal;">{{ dataset.title }}</span></h1>

        {% if not IS_LOGGED_IN %}
             <p>Please <a href="{% url 'view_login_page' %}">Log In</a> to see your Datasets.</p>
        {% endif %}

        {% if dataset %}


<table class="table table-condensed table-bordered">

     <tr>
        <th colspan="2">Dataset Information</th>
    </tr>
    <tr>
        <th class="text-primary">Title</th>
        <td>{{ dataset.title }}</td>
    </tr>
    <tr>
        <th class="text-primary">Status</th>
        <td>
            {% if dataset.status.is_error %}
                <span class="label label-warning">Fail</span> &nbsp;
            {% else %}
                {% if dataset.has_prediction %}
                    <span class="label label-success">OK</span> &nbsp;
                {% else %}
                    <span class="label label-info">OK</span> &nbsp;
                {% endif %}
            {% endif %}
            {{ dataset.status.human_name }} (id: {{ dataset.status.id }})
            {% if dataset.has_prediction %}
                <br /><br /><a class="btn btn-info btn-xs" href="{% url 'view_prediction_heatmap' dataset.md5 %}" target="_blank">View Heatmap</a>
                {% comment %}
                <br /><a id="lnk_show_hide_heatmap">show prediction heatmap</a>
                <!--<iframe id="id_heatmap_iframe" width="100%" height="600" src="{% url 'view_prediction_heatmap' dataset.md5 %}" style="display:none;"></iframe>-->
                {% endcomment %}
            {% endif %}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Description</th>
        <td>{{ dataset.description|linebreaks }}</td>
    </tr>
    <tr>
        <th class="text-primary">File Type</th>
        <td>
            {{ dataset.file_type|upper }}{% if dataset.is_fastq_file %},
                {% if dataset.is_fastq_pair_ended %}
                    Pair-end<br />
                {% else %}
                    Single-end<br />
                {% endif %}
            {% endif %}
        </td>
    </tr>
    {% if dataset.is_fastq_pair_ended and dataset.dropboxretrievallog %}
    <tr>
        <th class="text-primary">Pair-end Extension
            <br>"." or "_R"</th>
        <td>
            "{{ dataset.dropboxretrievallog.fastq_pair_end_extension }}"
        </td>
    </tr>
    {% endif %}
    <tr>
        <th class="text-primary">File Names from Dropbox</th>
        <td>
            {% if dataset.dropboxretrievallog %}
                {% for fname in dataset.dropboxretrievallog.selected_files %}
                ({{ forloop.counter }}) {{ fname }}<br />
                {% endfor %}
            {% else %}
                N/A
            {% endif %}
        </td>

    </tr>
    <tr>
        <th class="text-primary">Local Dataset Directory</th>
        <td>
            {{ dataset.file_directory }}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Local Dataset Directory Contents</th>
        <td>
            {% if local_directory_err %}
                <span class="label label-warning">Fail</span> &nbsp;
                {{ local_directory_err }}
            {% else %}
                {% for item in local_directory_contents %}
                    {% if forloop.first %}
                        <span class="label label-success">OK</span> &nbsp;<br />
                    {% endif %}
                    ({{ forloop.counter }}) {{ item }}<br />
                {% empty %}
                    <span class="label label-info">No files</span> &nbsp;
                    The directory is currently empty.  Have the Dropbox files been
                    retrieved?
                {% endfor %}
            {% endif %}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Pipeline Command</th>
        <td>
            {% if pipeline_command_found %}
                <span class="label label-info">OK</span> &nbsp;
                <br />{{ pipeline_command }}
            {% else %}
                <span class="label label-danger">Error</span>
                {{ pipeline_command_err|linebreaks }}
            {% endif %}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Created</th>
        <td>{{ dataset.created }}</td>
    </tr>
    <tr>
        <th class="text-primary">Modified</th>
        <td>{{ dataset.modified }}</td>
    </tr>
</table>
{% for script_run in script_runs %}
{% if forloop.first %}<h3>Script Runs</h3>{% endif %}


<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ script_run.created }} <small>updated: {{ script_run.modified }}</small></h3>
  </div>
  <div class="panel-body">
      {% if script_run.result_received %}
            {% if script_run.result_success %}
                <span class="label label-success">Success</span><br />
            {% else %}
                <span class="label label-warning">Fail</span><br />
            {% endif %}
      {% else %}
          <span class="label label-info">Results not received</span><br />
      {% endif %}
      Command run: <div class="well">{{ script_run.notes }}</div>

      {% if script_run.result_data %}
      Results
      <div class="well" id="result_div_{{ forloop.counter }}">{{ script_run.result_data }}</div>
      {% endif %}
  </div>
</div>
{% endfor %}


{% for note in dataset_notes %}
{% if forloop.first %}<h3>Notes</h3>{% endif %}

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ note.title }} <small>{{ note.modified }}</small></h3>
  </div>
  <div class="panel-body">
   {{ note.note|linebreaks  }}
  </div>
</div>
{% endfor %}
{% comment %}
<table class="table table-condensed table-bordered">
    <tr>
        <th colspan="2">Contact Information</th>
    </tr>
    <tr>
        <th class="text-primary">Name</th>
        <td>{{ tb_user }}
            {#{ dataset.middle_name }#}
            {#{ dataset.tb_user.last_name }#}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Affiliation</th>
        <td>{{ tb_user.affiliation }}</td>
    </tr>
      <tr>
        <th class="text-primary">Email</th>
        <td>{{ tb_user.user.email }}</td>
    </tr>
</table>
{% endcomment %}

{% endif %}

    </div>
</div>
{% block extra_footer_js %}
<script>
$(document).ready(function () {
    console.log('what?');
});
// show/hide heatmap
//$( document ).ready(function() {
    if ( $("#lnk_show_hide_heatmap").length ) {
        $("#lnk_show_hide_heatmap").click(function(){
            if ($("#id_heatmap_iframe").is(":visible")){
                $("#id_heatmap_iframe").hide();
            }else{
                $("#id_heatmap_iframe").show();
            };
        });
    }
//});
</script>
{% endblock %}


{% endblock %}
