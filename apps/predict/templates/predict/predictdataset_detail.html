{% extends "base.html" %}
{% load static predict_extras jsonify %}

{% block title %}My Datasets - Phthisis Ravens{% endblock %}
 
{% block extra_css %}
  <link href="{% static 'css/heatmap.css' %}" rel="stylesheet">
  <link href="{% static 'css/nv.d3.css' %}" rel="stylesheet">
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/jquery.min.js' %}"></script>
  <script src="{% static 'js/d3.js' %}"></script>
  <script src="{% static 'js/d3.tip.js' %}"></script>
  <script src="{% static 'js/nv.d3.js' %}"></script>
  <script src="{% static 'js/heatmap.js' %}"></script>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-lg-12">
      Return to
      <a href="{% url 'predict:view_my_datasets' %}">My Datasets</a>
      <h1>Dataset: <span style="font-weight:normal;">{{ object.title }}</span></h1>

      {% if object %}
        <table class="table table-condensed table-bordered">
          <tr>
            <th colspan="2">Dataset Information</th>
          </tr>
          <tr>
            <th class="text-primary">Title</th>
            <td>{{ object.title }}</td>
          </tr>
          <tr>
            <th class="text-primary">Status</th>
            <td>
            {% if object.status.is_error %}
                <span class="label label-warning">Fail</span> &nbsp;
            {% else %}
                {% if object.has_prediction %}
                    <span class="label label-success">OK</span> &nbsp;
                {% else %}
                    <span class="label label-info">OK</span> &nbsp;
                {% endif %}
            {% endif %}
            {{ object.status.human_name }} (id: {{ object.status.id }})
        </td>
    </tr>

{% if object.has_prediction %}
  <tr>
    <th class="text-primary">Heat Map</th>
    <td>
      <div id="heatmap" class="d3heatmap"></div>
      <div id="scatter" class="d3graph"><svg></svg></div>
      <script>

function scatter_plot(cols, data) {
  /*  
   * The idea here is to update an existing plot with new data.
   */
  var svg = d3.select('#scatter svg');

  svg[0][0].__data__ = data;
  var nvChart = svg[0][0].__chart__;

  nvChart.xAxis
      .axisLabel('Genetic Region')
      .tickFormat(function(d) { return cols[d]; })
      .tickValues([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21])
      .rotateLabels(-45);

  svg.data([data]).transition().duration(500).call(nvChart);
  nv.utils.windowResize(nvChart.update);
}


        $(document).ready(function() {
          var data = {"rows": null, "cols": null,
            "matrix": {{ object.get_heatmap|jsonify }}
          };
          var scat = data["matrix"]["scatter"];
          var options = {
            "xaxis_height": 80,
            "yaxis_width": 120,
            "xaxis_font_size": null,
            "yaxis_font_size": null,
            "brush_color": "#0000FF",
            "show_grid": true,
            "anim_duration": 500,
            "on_click": function(elem, x, x_label, y, y_label, datum) {
              scatter_plot(scat.cols, scat.data[y_label][x]);
            },
          }
          heatmap('#heatmap', data, options);

          nv.addGraph(function() {
            var data = Array();
            var chart = nv.models.scatterChart()
              .yDomain([0, 4]);

            var width = 1000;
            var height = 300;

            chart.margin({top: 20, right: 60, bottom: 60, left: 60});
            chart.height(height);
            chart.width(width);
            chart.yAxis.scale(100).orient("left")
                .axisLabel('Number of mutations')
                .tickFormat(d3.format("d"))
                .tickValues([0,1,2,3,4,5]);

            chart.showLegend(true);

            var svg = d3.select('#scatter svg')
                .attr('perserveAspectRatio', 'xMinYMid')
                .attr('width', width)
                .attr('height', height)
                .datum(data)
                .attr('viewBox', '0 0 ' + width + ' ' + height)
                .transition().duration(1200)
                .call(chart);

            chart.tooltip.contentGenerator(function (data) {
              ret = "<table>";
              $.each(data.point.tip, function(x, value) {
                ret += "<tr><th align=\"right\">" + value + "</th></tr>";
              });
              return ret + "</table>";
            });

            svg[0][0].__chart__ = chart;
          });
        });
      </script>
    </td>
  </tr>
{% endif %}

    <tr>
        <th class="text-primary">Description</th>
        <td>{{ object.description|linebreaks }}</td>
    </tr>
    <tr>
        <th class="text-primary">File Type</th>
        <td>
            {{ object.file_type|upper }}{% if object.is_fastq_file %},
                {% if object.is_fastq_pair_ended %}
                    Pair-end<br />
                {% else %}
                    Single-end<br />
                {% endif %}
            {% endif %}
        </td>
    </tr>
    {% if object.is_fastq_pair_ended and object.dropboxretrievallog %}
    <tr>
        <th class="text-primary">Pair-end Extension
            <br>"." or "_R"</th>
        <td>
            "{{ object.dropboxretrievallog.fastq_pair_end_extension }}"
        </td>
    </tr>
    {% endif %}
    <tr>
        <th class="text-primary">File Names from Dropbox</th>
        <td>
            {% if object.dropboxretrievallog %}
                {% for fname in object.dropboxretrievallog.selected_files %}
                ({{ forloop.counter }}) {{ fname }}<br />
                {% endfor %}
            {% else %}
                N/A
            {% endif %}
        </td>

    </tr>
    <tr>
        <th class="text-primary">Local Dataset Directory</th>
        <td>
            {{ object.file_directory }}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Local Dataset Directory Contents</th>
        <td>
          {% for item in object.files %}
            {% if forloop.first %}
                <span class="label label-success">OK</span> &nbsp;<br />
            {% endif %}
            ({{ forloop.counter }}) {{ item }}<br />
          {% empty %}
            <span class="label label-info">No files</span> &nbsp;
            The directory is currently empty.  Have the Dropbox files been
            retrieved?
          {% endfor %}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Pipeline Command</th>
        <td>
            {% if object.get_pipeline_command.0 %}
                <span class="label label-info">OK</span> &nbsp;
                <br />{{ pipeline_command }}
            {% else %}
                <span class="label label-danger">Error</span>
                {{ pipeline_command_err|linebreaks }}
            {% endif %}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Created</th>
        <td>{{ object.created }}</td>
    </tr>
    <tr>
        <th class="text-primary">Modified</th>
        <td>{{ object.modified }}</td>
    </tr>
</table>
{% for script_run in object.runs.all %}
{% if forloop.first %}<h3>Script Runs</h3>{% endif %}


<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ script_run.created }} <small>updated: {{ script_run.modified }}</small></h3>
  </div>
  <div class="panel-body">
      {% if script_run.result_received %}
            {% if script_run.result_success %}
                <span class="label label-success">Success</span><br />
            {% else %}
                <span class="label label-warning">Fail</span><br />
            {% endif %}
      {% else %}
          <span class="label label-info">Results not received</span><br />
      {% endif %}
      Command run: <div class="well">{{ script_run.notes }}</div>

      {% if script_run.result_data %}
      Results
      <div class="well" id="result_div_{{ forloop.counter }}">{{ script_run.result_data }}</div>
      {% endif %}
  </div>
</div>
{% endfor %}


{% for note in object.notes.all %}
{% if forloop.first %}<h3>Notes</h3>{% endif %}

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ note.title }} <small>{{ note.modified }}</small></h3>
  </div>
  <div class="panel-body">
   {{ note.note|linebreaks  }}
  </div>
</div>
{% endfor %}
{% comment %}
<table class="table table-condensed table-bordered">
    <tr>
        <th colspan="2">Contact Information</th>
    </tr>
    <tr>
        <th class="text-primary">Name</th>
        <td>{{ request.user }}
            {#{ object.middle_name }#}
            {#{ object.tb_user.last_name }#}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Affiliation</th>
        <td>{{ request.user.affiliation }}</td>
    </tr>
      <tr>
        <th class="text-primary">Email</th>
        <td>{{ tb_user.user.email }}</td>
    </tr>
</table>
{% endcomment %}

{% endif %}

    </div>
</div>
{% endblock %}

{% block extra_footer_js %}
<script type="text/javascript">

// show/hide heatmap
$( document ).ready(function() {
    if ( $("#lnk_show_hide_heatmap").length ) {
        $("#lnk_show_hide_heatmap").click(function(){
            if ($("#id_heatmap_iframe").is(":visible")){

                $("#id_heatmap_iframe").hide();
                $("#lnk_show_hide_heatmap").text('Show Prediction Heat Map (takes a second or two)');
            }else{
                $("#id_heatmap_iframe").show();
                $("#lnk_show_hide_heatmap").text('Hide Prediction Heat Map');
            };
        });
    }
});
</script>
{% endblock %}
