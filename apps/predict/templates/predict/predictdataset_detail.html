{% extends "base.html" %}
{% load cachebuster predict_extras jsonify %}

{% block extra_css %}
  <link href="{% static 'css/files.css' %}" rel="stylesheet">
  <link href="{% static 'css/heatmap.css' %}" rel="stylesheet">
  <link href="{% static 'css/nv.d3.css' %}" rel="stylesheet">
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/d3.js' %}"></script>
  <script src="{% static 'js/d3.tip.js' %}"></script>
  <script src="{% static 'js/nv.d3.js' %}"></script>
  <script src="{% static 'js/heatmap.js' %}"></script>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-lg-12">
      <h1>Dataset: <span style="font-weight:normal;">{{ object.title }}</span></h1>

      {% if object %}
        <table class="table table-condensed table-bordered">
          <tr>
            <th colspan="2">Dataset Information</th>
          </tr>
          <tr>
            <th class="text-primary">Description</th>
            <td>{{ object.description|linebreaks }}</td>
          </tr>
          <tr>
            <th class="text-primary">Data Type</th>
            <td>
              {{ object.file_type|upper }}{% if object.is_fastq_file %},
              {% if object.is_fastq_pair_ended %}Pair-end{% else %}Single-end{% endif %}<br/>
              {% endif %}
            </td>
          </tr>
          {% if object.files.count %}
          <tr>
            <th class="text-primary">Dataset Files</th>
            <td>
              {% for file in object.files.all %}
<div class="file">
  <div>
    {% if file.result %}
      {{ file.filename|default:file }}
      <span class="label label-success">Retrieved</span> &nbsp;
      <a href="{{ object.media_url }}/{{ file.filename }}"><span class="glyphicon glyphicon-download"></span></a>
    {% elif file.retrieval_start %}
      <span class="label label-danger">Failed</span> &nbsp;
    {% else %}
      <span class="label label-default">In Queue</span> &nbsp;
    {% endif %}
  </div>
</div>   
              {% endfor %}
            </td>
          </tr>
          {% endif %}
          {% if object.is_error %}
            <tr>
              <th class="text-primary">Status</th>
              <td>
                <span class="label label-warning">Fail</span> &nbsp;
                {{ object.get_status_display }} (id: {{ object.status }})
              </td>
            </tr>
          {% endif %}

{% if object.has_prediction %}
  <tr>
    <th class="text-primary">Resistance Prediction
      <i class="glyphicon glyphicon-info-sign" data-toggle="tooltip" title="See minimal list of predictive mutations in Farhat et al. AJRCCM 2016"></i>
      <i class="glyphicon glyphicon-question-sign" data-toggle="tooltip" title="DR=Drug Resistance, FN=False Negative, FP=False Positive"></i>
    </th>
    <td>
      <div id="heatmap" class="d3heatmap"></div>
      <script>
        $(document).ready(function() {
          var data = {"rows": null, "cols": null,
            "matrix": {{ object.get_heatmap|jsonify }}
          };
          make_heatmap(data, '#heatmap', '#scatter', "click on a box on the heamap to show mutations");
        });
      </script>
    </td>
  </tr>
  <tr>
    <th class="text-primary">Mutations</th>
    <td>
      <div id="scatter" class="d3graph">
        <h4 id="scatter_title"></h4>
        <svg id="scaller_plot"></svg>
      </div>
    </td>
  </tr>
</table>

<table class="table table-condensed table-bordered">
  <tr>
    <th colspan="2">Administration</th>
  </tr>
  </tr>
{% endif %}
  <tr>
    <th class="text-primary">Local Dataset Directory</th>
    <td>
      {% if object.directory_exists %}
        <span class="label label-success">OK</span>
      {% else %}
        <span class="label label-danger">Missing!</span>
      {% endif %}
      {{ object.file_directory }}
    </td>
  </tr>
    <tr>
        <th class="text-primary">Results Files</th>
        <td>
          {% for url, name in object.result_files %}
            {% if forloop.first %}
                <span class="label label-success">OK</span> &nbsp;<br />
            {% endif %}
            ({{ forloop.counter }}) {{ name }} 
            <a href="{{ url }}"><span class="glyphicon glyphicon-download"></span></a>
            <br />
          {% empty %}
            <span class="label label-info">No files</span> &nbsp;
            The directory is currently empty.  Have the Dropbox files been
            retrieved?
          {% endfor %}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Other Files</th>
        <td>
          {% for url, name in object.all_files %}
            ({{ forloop.counter }}) {{ name }} 
            <a href="{{ url }}"><span class="glyphicon glyphicon-download"></span></a>
            <br />
          {% endfor %}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Pipeline Command</th>
        <td>
            {% if object.get_pipeline_command.0 %}
                <span class="label label-info">OK</span> &nbsp;
                <br />{{ pipeline_command }}
            {% else %}
                <span class="label label-danger">Error</span>
                {{ pipeline_command_err|linebreaks }}
            {% endif %}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Created</th>
        <td>{{ object.created }}</td>
    </tr>
    <tr>
        <th class="text-primary">Modified</th>
        <td>{{ object.modified }}</td>
    </tr>
</table>
{% for script_run in object.runs.all %}
{% if forloop.first %}<h3>Script Runs</h3>{% endif %}


<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ script_run.created }} <small>updated: {{ script_run.modified }}</small></h3>
  </div>
  <div class="panel-body">
      {% if script_run.result_received %}
            {% if script_run.result_success %}
                <span class="label label-success">Success</span><br />
            {% else %}
                <span class="label label-warning">Fail</span><br />
            {% endif %}
      {% else %}
          <span class="label label-info">Results not received</span><br />
      {% endif %}
      Command run: <div class="well">{{ script_run.notes }}</div>

      {% if script_run.result_data %}
      Results
      <div class="well" id="result_div_{{ forloop.counter }}">{{ script_run.result_data }}</div>
      {% endif %}
  </div>
</div>
{% endfor %}


{% for note in object.notes.all %}
{% if forloop.first %}<h3>Notes</h3>{% endif %}

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ note.title }} <small>{{ note.modified }}</small></h3>
  </div>
  <div class="panel-body">
   {{ note.note|linebreaks  }}
  </div>
</div>
{% endfor %}
{% comment %}
<table class="table table-condensed table-bordered">
    <tr>
        <th colspan="2">Contact Information</th>
    </tr>
    <tr>
        <th class="text-primary">Name</th>
        <td>{{ request.user }}
            {#{ object.middle_name }#}
            {#{ object.tb_user.last_name }#}
        </td>
    </tr>
    <tr>
        <th class="text-primary">Affiliation</th>
        <td>{{ request.user.affiliation }}</td>
    </tr>
      <tr>
        <th class="text-primary">Email</th>
        <td>{{ tb_user.user.email }}</td>
    </tr>
</table>
{% endcomment %}

{% endif %}

    </div>
</div>
{% endblock %}

